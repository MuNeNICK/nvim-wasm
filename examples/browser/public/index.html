<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Neovim wasm demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <main class="page">
      <header class="hero">
        <div>
          <p class="eyebrow">nvim wasm / wasi</p>
          <h1>Neovim UI over msgpack RPC</h1>
          <p class="lede">
            This demo boots the wasm32-wasi build of Neovim in a Web Worker, attaches a
            minimal linegrid UI, and streams redraw events into this page.
            Cross-origin isolation is required because stdin uses SharedArrayBuffer.
          </p>
        </div>
        <div class="chip">WASM</div>
      </header>

      <section class="card controls">
        <div class="actions">
          <button id="start">Start Neovim</button>
          <button id="quit" class="ghost">Quit</button>
          <button id="reset" class="ghost">Restart</button>
          <button id="dump" class="ghost">Dump log</button>
          <button id="stop" class="ghost">Stop</button>
        </div>
        <p class="status" id="status">Not started</p>
        <p class="hint">
          Assets are pulled from <code>./nvim.wasm</code> and <code>./nvim-runtime.tar.gz</code>.
          Generate them with <code>../prepare.sh</code> and serve with COOP/COEP headers
          (use <code>python examples/browser/serve.py</code>) so SharedArrayBuffer works.
        </p>
      </section>

      <section class="card terminal">
        <div class="term-header">
          <div class="pill" id="mode">mode: -</div>
          <div class="pill">click canvas then type</div>
        </div>
        <div id="redraw-debug" class="hint small"></div>
        <div id="grid" class="grid" tabindex="0" aria-label="Neovim grid"></div>
        <div class="hint small">
          Keys are sent via <code>nvim_input</code>. Special keys: arrows, ESC, Enter, Backspace,
          Tab, Ctrl/Alt/Meta combos are translated to &lt;C-x&gt;/&lt;A-x&gt;/&lt;M-x&gt;.
        </div>
      </section>

      <section class="card logs">
        <div class="log-block">
          <div class="label-row">
            <div class="log-label">stderr</div>
            <button id="copy-stderr" class="ghost tiny" type="button">Copy</button>
          </div>
          <pre id="stderr" class="log muted"></pre>
        </div>
      </section>

      <section class="card scratch">
        <div class="scratch-header">
          <div>
            <div class="eyebrow">scratch buffer</div>
            <p class="lede small">テキストを貼り付けて Neovim 内の一時ドキュメントとして開き、/nvim/tmp 下に保存できます。</p>
          </div>
          <div class="chip ghost">Temp</div>
        </div>
        <div class="scratch-controls">
          <label class="input-label" for="doc-path">保存先パス</label>
          <input id="doc-path" class="input" value="/nvim/tmp/wasm-scratch.txt" />
        </div>
        <textarea id="doc-text" class="scratch-area" rows="8" placeholder="ここにテキストを貼り付けて「バッファに読み込み」で Neovim に送り込みます。"></textarea>
        <div class="actions">
          <button id="load-doc">バッファに読み込み</button>
          <button id="save-doc" class="ghost">現在バッファを保存</button>
          <button id="clear-doc" class="ghost">クリア</button>
        </div>
        <p class="hint small">バッファ名は保存先パスに設定されます。Neovim 側で編集・上書きできます。</p>
      </section>
    </main>

    <script type="module" src="./main.js"></script>
  </body>
</html>
